name: discogs-helper

services:
  db:
    image: mysql:8.0
    container_name: discogs-mysql
    command: ["mysqld", "--default-authentication-plugin=mysql_native_password"]
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-root_password_123}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-Discogs}
      - MYSQL_USER=${MYSQL_USER:-discogs_user}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-secure_password_123}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./database_schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-uroot", "-p${MYSQL_ROOT_PASSWORD:-root_password_123}"]
      interval: 10s
      timeout: 5s
      retries: 10

  api:
    build:
      context: ./discogs-back
      dockerfile: Dockerfile
      args:
        - SKIP_TESTS=false
      target: runtime
    container_name: discogs-api
    depends_on:
      db:
        condition: service_healthy
    dns:
      - 127.0.0.11  # Docker's internal DNS resolver (uses host's DNS)
      - 8.8.8.8
      - 8.8.4.4
    environment:
      # Database Configuration
      # Always use docker service name 'db' in docker-compose
      # For non-docker deployments, override MY_SQL_DB_HOST environment variable
      - MY_SQL_DB_HOST=${MY_SQL_DB_HOST:-db}
      - MY_SQL_DB_PORT=${MY_SQL_DB_PORT:-3306}
      - MY_SQL_DB_USER=${MY_SQL_DB_USER:-discogs_user}
      - MY_SQL_DB_PASSWORD=${MY_SQL_DB_PASSWORD:-secure_password_123}
      - MY_SQL_DB_DATABASE=${MY_SQL_DB_DATABASE:-Discogs}
      - MY_SQL_DB_CONNECTION_LIMIT=10
      # Server Configuration
      - PORT=3001
      - NODE_ENV=production
      # JWT Configuration
      - JWT_SECRET=${JWT_SECRET:-your-secret-key-change-in-production}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-24h}
      # Discogs API Configuration
      - DISCOGS_TOKEN=${DISCOGS_TOKEN}
      - DISCOGS_CONSUMER_KEY=${DISCOGS_CONSUMER_KEY}
      - DISCOGS_CONSUMER_SECRET=${DISCOGS_CONSUMER_SECRET}
      # OAuth callback - use localhost for EC2, service name for docker-compose
      - DISCOGS_OAUTH_CALLBACK_URL=${DISCOGS_OAUTH_CALLBACK_URL:-http://localhost:3001/api/users/discogs/oauth/callback}
      # Frontend URL - use localhost for EC2, service name for docker-compose
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:80}
      # CORS Configuration
      - CORS_ORIGIN=${CORS_ORIGIN:-*}
      # Logging
      - LOG_LEVEL=info
    ports:
      - "3001:3001"
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  web:
    build:
      context: ./react-front
      dockerfile: Dockerfile
      args:
        - REACT_APP_API_URL=${REACT_APP_API_URL:-}
    container_name: discogs-web
    depends_on:
      - api
    ports:
      - "8080:80"
      # SSL certificates not needed for local development
      # - "443:443"
    restart: unless-stopped

volumes:
  mysql_data:


